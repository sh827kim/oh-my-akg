# Archi.Navi 레포 구조 / npm 배포 형태 검토

작성일: 2026-02-20

## 1. 검토 범위

- 단일 구성(현행) 유지 vs 모노레포 + 패키지 분리
- UI를 포함한 형태로 npm 배포 가능 여부 및 권장 배포 모델

---

## 2. 현재 상태 요약

- 웹앱은 `apps/web`, 실행 로직은 `packages/cli`로 분리됨
- 루트 패키지는 실행형 배포 엔트리(`bin: archi-navi`)를 제공
- CLI는 `up` 명령으로 Next 바이너리를 직접 실행
- 현재 배포 전략은 실행형 단일 패키지(전이 단계) + 내부 모듈 분리 구조

참고 파일:
- `package.json`
- `cli/index.ts`
- `cli/commands/sync.ts`
- `lib/db.ts`

---

## 3. 단일 구성 vs 모노레포 비교

### 3.1 단일 구성 유지

장점
- 전환 비용이 가장 낮음
- 초기 구현 속도가 빠름

한계
- 도메인 모델/추론 엔진/CLI/UI의 변경 주기가 달라질수록 충돌 증가
- npm 배포 단위 분리가 어렵고 릴리즈 경계가 불명확
- 테스트/빌드 범위가 불필요하게 커짐

### 3.2 모노레포 + 패키지 분리

장점
- 모델/엔진/CLI/UI를 독립 버전 정책으로 운영 가능
- npm 배포 타겟(`@archi-navi/cli`, `@archi-navi/core`) 분리 용이
- 재사용 가능한 공통 모델/유틸을 명확히 캡슐화

한계
- 초기 전환 비용(워크스페이스 구성, 경계 재정의, import 정리) 발생

---

## 4. 권장안

## 결론
- **모노레포 전환을 권장**
- 단, 한 번에 전면 분해하지 말고 2단계로 전환

## 권장 구조(예시)
- `apps/web` : Next.js UI
- `packages/core` : object model, relation schema, roll-up 계산, 공통 타입
- `packages/inference` : 추론 파이프라인(AST 플러그인 포함)
- `packages/cli` : 배치/동기화/승인 작업 CLI
- `packages/ui-kit` : 공통 UI 컴포넌트(선택)

## 전환 원칙
- 현재 기능 유지 우선(행동 동일성 유지)
- DB 스키마와 API 계약을 먼저 고정 후 패키지 분리
- import 경로를 단계적으로 `packages/*`로 전환

---

## 5. UI 포함 npm 배포 가능성 검토

## 가능 여부
- **가능**
- 단, npm에는 “웹앱 소스”가 아니라 “실행 가능한 제품 엔트리”를 배포해야 현실적

## 현실적인 배포 모델

### 모델 A. 실행형 패키지 배포 + UI 로컬 실행(현재 적용)
- npm 패키지: `archi-navi` (루트 실행형 패키지)
- 사용 예: `npx archi-navi up`
- 동작:
  - 로컬 데이터 경로 생성/검증
  - 웹 UI(Next 앱) 실행
  - 브라우저 URL 출력

장점
- 사용자 온보딩이 간단
- npm 생태계에 자연스럽게 맞음

주의점
- 패키지 용량 관리 필요(`files` 범위 최적화)

### 모델 B. 라이브러리형 UI 배포
- React 컴포넌트 라이브러리로 배포
- 본 프로젝트 목적(실행형 아키텍처 도구)과는 맞지 않음

### 모델 C. npm + Docker 병행 배포
- npm: 로컬 빠른 시작
- Docker: 운영 안정성/재현성
- 장기적으로 가장 실용적

---

## 6. 선행 조건 / 기술 체크리스트

1. DB 경로 환경변수 표준화
- 현재 고정 경로 사용을 환경변수 기반으로 전환 필요

2. 런타임 엔트리 정리
- CLI와 웹 실행 엔트리를 분리하고 공통 설정 로더 제공

3. 산출물 전략
- `apps/web`은 standalone 빌드 산출물을 생성
- CLI에서 해당 산출물을 실행/관리

4. 배포 메타데이터
- `bin` 엔트리
- 플랫폼별 실행 검증(macOS/Linux 우선)

5. 버전 정책
- core/inference/cli/web 간 변경 영향 규칙 정의

---

## 7. 최종 권고

- 구조: **모노레포 전환 + 패키지 분리**
- 배포: **npm 실행형 패키지 배포**, UI는 `archi-navi up`이 구동
- 운영: **npm + Docker 병행 제공**

이 조합이 Archi.Navi의 제품 성격(로컬 분석 + 시각화 UI + 승인 워크플로우)에 가장 적합하다.
